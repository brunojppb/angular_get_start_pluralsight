<!DOCTYPE html>
<html ng-app="myApp">

<head>
  <meta charset="utf-8">
  <title>Angular</title>
</head>
<script src="js/angular.js"></script>

<body>

  <div ng-controller="HttpController">
    <h1>$http Service</h1>
    {{ countdown }}
    <form name="searchuser" ng-submit="searchGH(githubUser)">
      <input type="text" required placeholder="type your github username" ng-model="githubUser">
      <input type="submit" value="search" ng-click="searchGH(githubUser)">
    </form>

    <div ng-show="user">
      <strong>Github: {{githubUser}}</strong>
      <br />
      <strong>Name: {{user.name}}</strong>
      <br />
      <strong>Location: {{user.location}}</strong>
      <br />
      <img ng-src="{{user.avatar_url}}" style="width: 80px; height: 80px;" />
      <br> Order:
      <select ng-model="repoSortOrder">
        <option value="+name">Name</option>
        <option value="-stargazers_count">Stars</option>
      </select>
      <h1>Repos</h1>
      <table ng-hide="!user">
        <thead>
          <tr>
            <th>
              Name
            </th>
            <th>
              Starts
            </th>
            <th>
              Language
            </th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="repo in repos | orderBy: repoSortOrder">
            <td>{{repo.name}}</td>
            <td>{{repo.stargazers_count | number}}</td>
            <td>{{repo.language}}</td>
          </tr>
        </tbody>
      </table>

    </div>
  </div>


</body>

<script type="text/javascript">
  var myApp = angular.module('myApp', []);

  myApp.controller('HttpController', ['$scope', '$http', '$interval', function($scope, $http, $interval) {

    var onUserComplete = function(response) {
      $scope.user = response.data;
      $http.get($scope.user.repos_url + '?client_id=1a124cf84d26ea005536&client_secret=4db2c18e0d12e203c8386ee4e8d8bc49e66ed6ac')
        .then(onRepos);
    }

    var onError = function(err) {
      $scope.error = "Could not fetch the user."
    }

    var onRepos = function(response) {
      $scope.repos = response.data;
    }

    var decrementCountdown = function() {
      $scope.countdown -= 1;
      if($scope.countdown < 1) {
        $scope.searchGH($scope.githubUser);
      }
    }

    var startCountdown = function(){
      $interval(decrementCountdown, 1000, $scope.countdown);
    }

    $scope.searchGH = function(username) {
      var url = "https://api.github.com/users/" + username + '?client_id=1a124cf84d26ea005536&client_secret=4db2c18e0d12e203c8386ee4e8d8bc49e66ed6ac';
      $http.get(url)
        .then(onUserComplete, onError);
    }

    $scope.repoSortOrder = '-stargazers_count';
    $scope.countdown = 5;
    startCountdown();
  }]);
</script>

</html>
